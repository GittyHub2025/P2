<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>P3 åæ–‡é—ªå¡ (P3 Chinese Flashcards)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }
        .shake { animation: shake 0.5s ease-in-out; }

        .correct-state-static {
            background-color: #22c55e !important; /* green-500 */
            color: white !important;
        }
        .correct-state-static #questionText { display: none !important; }
        .correct-state-static #feedbackText,
        .correct-state-static #feedbackIconContainer { color: white !important; }

        .incorrect-state {
            background-color: #ef4444 !important; /* red-500 */
            color: white !important;
            border-color: #b91c1c !important; /* red-700 */
        }
        .incorrect-state #questionText { display: none !important; }
        .incorrect-state #feedbackText,
        .incorrect-state #feedbackIconContainer { color: white !important; }

        .annotated-sentence-container {
            font-size: 1.5rem; /* Large font for the sentence */
            font-weight: 600;
            line-height: 2.5;
            margin-bottom: 1rem;
            color: white;
            background-color: rgba(0, 0, 0, 0.15);
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .word-anno {
            display: inline-block;
            text-align: center;
            margin: 0 0.25rem;
            padding: 0 0.1rem;
        }
        .word-anno .pinyin {
            display: block;
            font-size: 0.9rem;
            font-weight: 400;
            color: #fce7f3; /* A lighter pink/white for pinyin */
        }
        .english-explanation {
            font-style: italic;
            margin-top: 1rem;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            font-weight: 500;
            color: white;
            padding: 0.5rem;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 0.375rem;
        }
        .explanation-box {
            font-size: 0.9rem;
            display: block;
            margin-top: 0.5rem;
            font-weight: normal;
            background-color: rgba(0, 0, 0, 0.1);
            padding: 0.5rem; border-radius: 0.375rem;
        }
        .prompt-guidance {
             font-size: 0.875rem; display: block; margin-top: 1rem; font-weight: bold;
        }

        .choice-button, .action-button {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            border-radius: 0.5rem; font-weight: 600;
            padding: 0.75rem 0.5rem; text-align: center;
            border: 1px solid transparent;
        }
        .choice-button:hover:not(:disabled), .action-button:hover {
            transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.12);
        }
        .choice-button:active:not(:disabled), .action-button:active {
            transform: translateY(0px); box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .choice-button:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        .choice-button.forced-disabled-look { opacity: 0.5; }
        .choice-button:disabled:hover { transform: none; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }

        .clickable-card { cursor: pointer; }
        #progressBarFill { transition: width 0.3s ease-out; }
        #confettiCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 0.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }

        .race-track-container { position: relative; width: 100%; height: 30px; margin-top: 20px; margin-bottom: 20px; z-index: 1; }
        .race-track { position: absolute; bottom: 0; left: 0; width: calc(100% - 30px); height: 10px; background-color: #d1d5db; border-radius: 5px; z-index: 2; }
        .race-track-fill { position: absolute; bottom: 0; left: 0; height: 10px; background-color: #3b82f6; border-radius: 5px; width: 0%; z-index: 3; transition: width 1.5s ease-out; }
        .rocket { position: absolute; bottom: -8px; left: 0; font-size: 36px; transform: translateX(-50%); z-index: 10; transition: left 1.5s ease-out; }
        .checkered-flag { position: absolute; bottom: -8px; right: 0; font-size: 24px; transform: translateX(50%); z-index: 10; }

        #questionText { word-break: break-word; hyphens: auto; font-size: 1.75rem; }
        @media (min-width: 768px) { #questionText { font-size: 2rem; } }
        .choice-button { white-space: normal; word-break: break-word; line-height: 1.4; min-height: 60px; display: flex; align-items: center; justify-content: center; font-size: 1.125rem; }
        @media (min-width: 768px) { .choice-button { font-size: 1.25rem; } }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-sky-100 via-blue-100 to-indigo-100 min-h-screen flex items-center justify-center p-4">

    <div id="appContainer" class="w-full max-w-md mx-auto">

        <!-- Name Input Modal -->
         <div id="nameModal" class="modal">
             <div class="modal-content text-center">
                 <h2 class="text-xl md:text-2xl font-semibold mb-4 text-blue-700">æ¬¢è¿ï¼Œå°æœ‹å‹ï¼</h2>
                 <p class="text-slate-600 mb-4">è¯·è¾“å…¥ä½ çš„åå­—ï¼Œå¼€å§‹å­¦ä¹ åæ–‡å§ï¼</p>
                 <input type="text" id="userNameInput" placeholder="ä½ çš„åå­—" class="w-full p-2 border border-slate-300 rounded mb-4 focus:ring-blue-500 focus:border-blue-500 text-center text-lg">
                 <button onclick="saveUserName()" class="action-button bg-blue-500 hover:bg-blue-600 text-white w-full py-3 px-6 text-lg">å¼€å§‹å­¦ä¹ ï¼</button>
             </div>
         </div>

        <!-- Set Selection Screen -->
        <div id="setSelectionScreen" class="hidden bg-white p-6 md:p-8 rounded-xl shadow-lg text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-blue-800 mb-2">P3 åæ–‡ç»ƒä¹ </h1>
            <p class="text-slate-600 mb-8">è¯·é€‰æ‹©ä¸€ä¸ªç»ƒä¹ ï¼</p>
            <div id="setButtonsContainer" class="grid grid-cols-1 gap-4">
                <!-- Buttons for flashcard sets will be dynamically added here by JS -->
            </div>
        </div>

        <!-- Flashcard Screen -->
        <div id="flashcardScreen" class="hidden bg-white p-6 md:p-8 rounded-xl shadow-lg">
            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-slate-600">è¿›åº¦</span>
                    <span id="progressText" class="text-sm font-medium text-blue-700">0 / 0</span> </div>
                <div class="w-full bg-slate-200 rounded-full h-2.5">
                    <div id="progressBarFill" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <div id="flashcard" class="bg-white border border-slate-300 rounded-lg p-6 mb-6 text-center min-h-[200px] flex flex-col items-center justify-center transition-colors duration-300">
                 <div id="flashcardContent" class="w-full flex flex-col items-center justify-center">
                     <div id="feedbackIconContainer" class="hidden text-7xl md:text-8xl mb-2"></div>
                     <p id="questionText" class="font-semibold text-slate-800"></p>
                     <div id="feedbackText" class="mt-2 text-base md:text-lg font-semibold"></div>
                     <p id="continueText" class="mt-4 text-sm text-slate-500 hidden">ç‚¹å‡»å¡ç‰‡ç»§ç»­...</p>
                 </div>
            </div>

            <div id="answerChoices" class="grid grid-cols-1 gap-3 md:gap-4">
                <button id="choice1" class="choice-button bg-slate-100 hover:bg-slate-200 text-slate-700"></button>
                <button id="choice2" class="choice-button bg-slate-100 hover:bg-slate-200 text-slate-700"></button>
                <button id="choice3" class="choice-button bg-slate-100 hover:bg-slate-200 text-slate-700"></button>
            </div>
             <button onclick="showSetSelection()" class="action-button mt-6 bg-slate-500 hover:bg-slate-600 text-white w-full text-sm py-3 px-6">è¿”å›é€‰é¢˜</button>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="hidden bg-white p-6 md:p-8 rounded-xl shadow-lg text-center">
            <h2 id="resultsHeading" class="text-2xl md:text-3xl font-bold text-blue-700 mb-4"></h2>
            <div class="bg-emerald-500 text-white p-4 rounded-lg mb-6">
                <p class="text-lg md:text-xl font-semibold mb-1">ä½ çš„åˆ†æ•°:</p>
                <p id="scoreDisplay" class="text-4xl md:text-5xl font-bold italic"></p>
            </div>
            <div class="race-track-container">
                <div class="race-track"></div>
                <div id="raceTrackFill" class="race-track-fill bg-blue-500"></div>
                <span id="rocketEl" class="rocket">ğŸš€</span>
                <span id="checkeredFlag" class="checkered-flag">ğŸ</span>
            </div>
            <p class="text-lg text-slate-700 mb-2">æ­£ç¡®ç‡: <span id="percentage" class="font-semibold"></span>%</p>
            <p class="text-lg text-slate-700 mb-6">ç”¨æ—¶: <span id="timeTaken" class="font-semibold"></span> ç§’</p>
            <p id="encouragementText" class="text-lg text-blue-700 font-semibold mb-6"></p>
            <div id="incorrectListContainer" class="mb-6 text-left">
                <h3 class="text-xl font-semibold text-red-600 mb-3">å¤ä¹ é”™é¢˜:</h3>
                <ul id="incorrectList" class="list-disc list-inside space-y-2 text-slate-600 text-sm"></ul>
                 <p id="noIncorrectText" class="text-emerald-600 font-semibold hidden">å¤ªæ£’äº†ï¼Œæ²¡æœ‰é”™é¢˜ï¼</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="redoIncorrectButton" onclick="redoIncorrect()" class="action-button bg-orange-500 hover:bg-orange-600 text-white w-full py-3 px-6">é‡åšé”™é¢˜</button>
                <button onclick="showSetSelection()" class="action-button bg-blue-500 hover:bg-blue-600 text-white w-full py-3 px-6">é€‰æ‹©å…¶ä»–ç»ƒä¹ </button>
            </div>
        </div>
    </div>
    <canvas id="confettiCanvas"></canvas>

   <script>
    // --- Configuration ---
    const QUESTIONS_PER_SET = 12; // Adjusted for P3 level
    const AUTO_PROCEED_DELAY = 1800;
    const USER_NAME_STORAGE_KEY = 'p3ChineseApp_v1';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwxl5mcaKKp3rXABfN6tMDqzUMCZ7eUTUt3LeoO8xFlwlSTuJqbOMY9vNxwSatucjec/exec';

    // --- NEW FLASHCARD SETS (P3 Level) ---
    const allFlashcardSets = {
        "ç¬¬ä¸€ç»„ï¼šè®¤ä¸€è®¤ (Recognition)": [
            { id: 'p3s1q1', question: "â€œå¤§è±¡â€çš„æ‹¼éŸ³æ˜¯ä»€ä¹ˆï¼Ÿ", options: ["dÃ  xiÃ ng", "dÃ  xiÇng", "tÇ xiÃ ng"], correctAnswer: "dÃ  xiÃ ng", 
              explanation: "å¤§è±¡(dÃ  xiÃ ng)æ˜¯ä¸€ç§é¼»å­å¾ˆé•¿çš„å¤§åŠ¨ç‰©ã€‚", 
              annotatedSentence: `<div class="word-anno">å¤§è±¡<span class="pinyin">dÃ  xiÃ ng</span></div>`, 
              englishExplanation: "English: The pinyin for å¤§è±¡ (elephant) is 'dÃ  xiÃ ng'." },
            { id: 'p3s1q2', question: "æˆ‘åœ¨è·¯è¾¹æ¡åˆ°ä¸€å—å°ï¼ˆã€€ï¼‰ã€‚", options: ["çŸ³å¤´", "æœ¨å¤´", "çš®çƒ"], correctAnswer: "çŸ³å¤´", 
              explanation: "çŸ³å¤´(shÃ­ tou)æ˜¯è·¯è¾¹å¸¸è§ç¡¬ç¡¬çš„ä¸œè¥¿ã€‚", 
              annotatedSentence: `<span class="word-anno">æˆ‘<span class="pinyin">wÇ’</span></span><span class="word-anno">æ¡åˆ°<span class="pinyin">jiÇn dÃ o</span></span><span class="word-anno">ä¸€å—<span class="pinyin">yÄ« kuÃ i</span></span><span class="word-anno">å°<span class="pinyin">xiÇo</span></span><span class="word-anno">çŸ³å¤´<span class="pinyin">shÃ­ tou</span></span>`, 
              englishExplanation: "English: 'çŸ³å¤´' (shÃ­ tou) means stone. It's something small and hard you can find on the roadside." },
            { id: 'p3s1q3', question: "å¦¹å¦¹åœ¨ç©ç§¯æœ¨ï¼Œå¥¹æ­äº†ä¸€ä¸ªï¼ˆã€€ï¼‰ã€‚", options: ["æ–¹å—", "åœ†çƒ", "æ˜Ÿæ˜Ÿ"], correctAnswer: "æ–¹å—", 
              explanation: "æ–¹å—(fÄng kuÃ i)æ˜¯ç§¯æœ¨çš„ä¸€ç§å½¢çŠ¶ï¼Œåƒä¸€ä¸ªæ­£æ–¹å½¢çš„ç›’å­ã€‚", 
              annotatedSentence: `<span class="word-anno">å¥¹<span class="pinyin">tÄ</span></span><span class="word-anno">æ­äº†<span class="pinyin">dÄ le</span></span><span class="word-anno">ä¸€ä¸ª<span class="pinyin">yÄ« gÃ¨</span></span><span class="word-anno">æ–¹å—<span class="pinyin">fÄng kuÃ i</span></span>`, 
              englishExplanation: "English: 'æ–¹å—' (fÄng kuÃ i) means 'square block' or 'cube', a common shape for building blocks (ç§¯æœ¨)." },
            { id: 'p3s1q4', question: "â€œæœ‹å‹â€çš„æ‹¼éŸ³æ˜¯ä»€ä¹ˆï¼Ÿ", options: ["pÃ©ng you", "pÃ©n yÇ’u", "pÃ©ng yÇ’u"], correctAnswer: "pÃ©ng yÇ’u", 
              explanation: "æœ‹å‹(pÃ©ng yÇ’u)æ˜¯å’Œä½ ä¸€èµ·ç©ï¼Œå¯¹ä½ å¥½çš„äººã€‚", 
              annotatedSentence: `<div class="word-anno">æœ‹å‹<span class="pinyin">pÃ©ng yÇ’u</span></div>`, 
              englishExplanation: "English: The pinyin for æœ‹å‹ (friend) is 'pÃ©ng yÇ’u'." },
            { id: 'p3s1q5', question: "ï¼ˆã€€ï¼‰çš„é¼»å­é•¿é•¿çš„ã€‚", options: ["å¤§è±¡", "å°ç‹—", "å°çŒ«"], correctAnswer: "å¤§è±¡", 
              explanation: "å¤§è±¡(dÃ  xiÃ ng)æœ€ç‰¹åˆ«çš„åœ°æ–¹å°±æ˜¯å®ƒæœ‰é•¿é•¿çš„é¼»å­ã€‚", 
              annotatedSentence: `<span class="word-anno">å¤§è±¡<span class="pinyin">dÃ  xiÃ ng</span></span><span class="word-anno">çš„<span class="pinyin">de</span></span><span class="word-anno">é¼»å­<span class="pinyin">bÃ­ zi</span></span><span class="word-anno">é•¿é•¿çš„<span class="pinyin">chÃ¡ng chÃ¡ng de</span></span>`, 
              englishExplanation: "English: 'å¤§è±¡' (dÃ  xiÃ ng) is the elephant, which is famous for its long trunk (é¼»å­)." },
            { id: 'p3s1q6', question: "å¤©ä¸Šçš„ï¼ˆã€€ï¼‰æ˜¯ç™½è‰²çš„ã€‚", options: ["äº‘", "å¤ªé˜³", "æœˆäº®"], correctAnswer: "äº‘", 
              explanation: "äº‘(yÃºn)æ˜¯å¤©ç©ºä¸­é£˜ç€çš„ï¼Œé€šå¸¸æ˜¯ç™½è‰²çš„ã€‚", 
              annotatedSentence: `<span class="word-anno">å¤©ä¸Š<span class="pinyin">tiÄn shÃ ng</span></span><span class="word-anno">çš„<span class="pinyin">de</span></span><span class="word-anno">äº‘<span class="pinyin">yÃºn</span></span><span class="word-anno">æ˜¯<span class="pinyin">shÃ¬</span></span><span class="word-anno">ç™½è‰²<span class="pinyin">bÃ¡i sÃ¨</span></span><span class="word-anno">çš„<span class="pinyin">de</span></span>`, 
              englishExplanation: "English: 'äº‘' (yÃºn) means cloud. Clouds in the sky are typically white." },
            { id: 'p3s1q7', question: "æˆ‘ä»¬å»ï¼ˆã€€ï¼‰ä¸Šå­¦ã€‚", options: ["å­¦æ ¡", "å…¬å›­", "å®¶é‡Œ"], correctAnswer: "å­¦æ ¡", 
              explanation: "å­¦æ ¡(xuÃ© xiÃ o)æ˜¯æˆ‘ä»¬å­¦ä¹ çŸ¥è¯†çš„åœ°æ–¹ã€‚", 
              annotatedSentence: `<span class="word-anno">æˆ‘ä»¬<span class="pinyin">wÇ’ men</span></span><span class="word-anno">å»<span class="pinyin">qÃ¹</span></span><span class="word-anno">å­¦æ ¡<span class="pinyin">xuÃ© xiÃ o</span></span><span class="word-anno">ä¸Šå­¦<span class="pinyin">shÃ ng xuÃ©</span></span>`, 
              englishExplanation: "English: 'å­¦æ ¡' (xuÃ© xiÃ o) means school, which is the place you go to attend classes (ä¸Šå­¦)." },
            { id: 'p3s1q8', question: "â€œè‹¹æœâ€çš„æ‹¼éŸ³æ˜¯ä»€ä¹ˆï¼Ÿ", options: ["pÃ­ng guÇ’", "pÇng guÇ’", "pÃ­ng guÅ"], correctAnswer: "pÃ­ng guÇ’", 
              explanation: "è‹¹æœ(pÃ­ng guÇ’)æ˜¯ä¸€ç§å¥½åƒçš„æ°´æœï¼Œé€šå¸¸æ˜¯çº¢è‰²çš„ã€‚", 
              annotatedSentence: `<div class="word-anno">è‹¹æœ<span class="pinyin">pÃ­ng guÇ’</span></div>`, 
              englishExplanation: "English: The pinyin for è‹¹æœ (apple) is 'pÃ­ng guÇ’'." },
            { id: 'p3s1q9', question: "æˆ‘ç”¨ï¼ˆã€€ï¼‰å†™å­—ã€‚", options: ["é“…ç¬”", "å°ºå­", "æ©¡çš®"], correctAnswer: "é“…ç¬”", 
              explanation: "é“…ç¬”(qiÄn bÇ)æ˜¯æˆ‘ä»¬ç”¨æ¥å†™å­—å’Œç”»ç”»çš„å·¥å…·ã€‚", 
              annotatedSentence: `<span class="word-anno">æˆ‘<span class="pinyin">wÇ’</span></span><span class="word-anno">ç”¨<span class="pinyin">yÃ²ng</span></span><span class="word-anno">é“…ç¬”<span class="pinyin">qiÄn bÇ</span></span><span class="word-anno">å†™å­—<span class="pinyin">xiÄ› zÃ¬</span></span>`, 
              englishExplanation: "English: 'é“…ç¬”' (qiÄn bÇ) means pencil. It is the tool used for writing (å†™å­—)." },
            { id: 'p3s1q10', question: "æ¡Œå­ä¸Šæœ‰ä¸€ä¸ªçº¢è‰²çš„ï¼ˆã€€ï¼‰ã€‚", options: ["æ–¹å—", "çŸ³å¤´", "çš®çƒ"], correctAnswer: "æ–¹å—", 
              explanation: "æ–¹å—(fÄng kuÃ i)å¯ä»¥æ˜¯ä¸€ç§ç©å…·ï¼Œæ”¾åœ¨æ¡Œå­ä¸Šã€‚", 
              annotatedSentence: `<span class="word-anno">æ¡Œå­ä¸Š<span class="pinyin">zhuÅ zi shÃ ng</span></span><span class="word-anno">æœ‰<span class="pinyin">yÇ’u</span></span><span class="word-anno">ä¸€ä¸ª<span class="pinyin">yÄ« gÃ¨</span></span><span class="word-anno">çº¢è‰²<span class="pinyin">hÃ³ng sÃ¨</span></span><span class="word-anno">çš„<span class="pinyin">de</span></span><span class="word-anno">æ–¹å—<span class="pinyin">fÄng kuÃ i</span></span>`, 
              englishExplanation: "English: The question describes a red 'æ–¹å—' (fÄng kuÃ i - square block) on the table." },
            { id: 'p3s1q11', question: "â€œé«˜å…´â€çš„æ‹¼éŸ³æ˜¯ä»€ä¹ˆï¼Ÿ", options: ["gÄo xÃ¬ng", "gÄo xÄ«ng", "gÇo xÃ¬ng"], correctAnswer: "gÄo xÃ¬ng", 
              explanation: "é«˜å…´(gÄo xÃ¬ng)å°±æ˜¯å¼€å¿ƒçš„æ„æ€ã€‚", 
              annotatedSentence: `<div class="word-anno">é«˜å…´<span class="pinyin">gÄo xÃ¬ng</span></div>`, 
              englishExplanation: "English: The pinyin for é«˜å…´ (happy, glad) is 'gÄo xÃ¬ng'." },
            { id: 'p3s1q12', question: "åŠ¨ç‰©å›­é‡Œæœ‰ï¼ˆã€€ï¼‰ã€‚", options: ["å¤§è±¡", "è€å¸ˆ", "å·´å£«"], correctAnswer: "å¤§è±¡", 
              explanation: "å¤§è±¡(dÃ  xiÃ ng)æ˜¯ä¸€ç§åŠ¨ç‰©ï¼Œæ‰€ä»¥å®ƒåœ¨åŠ¨ç‰©å›­é‡Œã€‚", 
              annotatedSentence: `<span class="word-anno">åŠ¨ç‰©å›­é‡Œ<span class="pinyin">dÃ²ng wÃ¹ yuÃ¡n lÇ</span></span><span class="word-anno">æœ‰<span class="pinyin">yÇ’u</span></span><span class="word-anno">å¤§è±¡<span class="pinyin">dÃ  xiÃ ng</span></span>`, 
              englishExplanation: "English: An elephant ('å¤§è±¡') is an animal you would find in a zoo (åŠ¨ç‰©å›­)." },
        ],
        "ç¬¬äºŒç»„ï¼šè¯»ä¸€è¯» (Reading)": [
             { id: 'p3s2q1', question: "ä¸‹è¯¾äº†ï¼Œï¼ˆã€€ï¼‰ä¸€èµ·å»ç©å§ï¼", options: ["æˆ‘è·Ÿä½ ", "è€å¸ˆå’Œæˆ‘ä»¬", "çˆ¸çˆ¸å¦ˆå¦ˆ"], correctAnswer: "æˆ‘è·Ÿä½ ", 
              explanation: "â€œæˆ‘è·Ÿä½ â€æ˜¯æœ‹å‹ä¹‹é—´äº’ç›¸é‚€è¯·æ—¶è¯´çš„è¯ã€‚", 
              annotatedSentence: `<span class="word-anno">æˆ‘è·Ÿä½ <span class="pinyin">wÇ’ gÄ“n nÇ</span></span><span class="word-anno">ä¸€èµ·<span class="pinyin">yÄ« qÇ</span></span><span class="word-anno">å»<span class="pinyin">qÃ¹</span></span><span class="word-anno">ç©å§<span class="pinyin">wÃ¡n ba</span></span>`, 
              englishExplanation: "English: 'æˆ‘è·Ÿä½ ' (wÇ’ gÄ“n nÇ) means 'me and you'. It's a common way for friends to suggest doing something together." },
            { id: 'p3s2q2', question: "ä½ ï¼ˆã€€ï¼‰é‚£æœ¬æ–°çš„æ•…äº‹ä¹¦å—ï¼Ÿ", options: ["çœ‹è¿‡", "åƒè¿‡", "å¬è¿‡"], correctAnswer: "çœ‹è¿‡", 
              explanation: "ä¹¦æ˜¯ç”¨çœ¼ç›çœ‹çš„ï¼Œæ‰€ä»¥ç”¨â€œçœ‹è¿‡â€ã€‚", 
              annotatedSentence: `<span class="word-anno">ä½ <span class="pinyin">nÇ</span></span><span class="word-anno">çœ‹è¿‡<span class="pinyin">kÃ n guo</span></span><span class="word-anno">é‚£æœ¬<span class="pinyin">nÃ  bÄ›n</span></span><span class="word-anno">æ•…äº‹ä¹¦<span class="pinyin">gÃ¹ shi shÅ«</span></span><span class="word-anno">å—<span class="pinyin">ma</span></span>`, 
              englishExplanation: "English: 'çœ‹è¿‡' (kÃ n guo) means 'have seen' or 'have read'. You read a book (æ•…äº‹ä¹¦)." },
            { id: 'p3s2q3', question: "å¦¹å¦¹åœ¨è‰åœ°ä¸Šå¿«ä¹åœ°ï¼ˆã€€ï¼‰ã€‚", options: ["è·³é£æœº", "ç¡è§‰", "åƒé¥­"], correctAnswer: "è·³é£æœº", 
              explanation: "è·³é£æœº(tiÃ o fÄ“i jÄ«)æ˜¯ä¸€ç§æ¸¸æˆï¼Œå¯ä»¥åœ¨è‰åœ°ä¸Šç©ã€‚", 
              annotatedSentence: `<span class="word-anno">å¦¹å¦¹<span class="pinyin">mÃ¨i mei</span></span><span class="word-anno">åœ¨<span class="pinyin">zÃ i</span></span><span class="word-anno">è‰åœ°ä¸Š<span class="pinyin">cÇo dÃ¬ shÃ ng</span></span><span class="word-anno">è·³é£æœº<span class="pinyin">tiÃ o fÄ“i jÄ«</span></span>`, 
              englishExplanation: "English: 'è·³é£æœº' (tiÃ o fÄ“i jÄ«) is the game 'hopscotch'. It's a fun activity to do on the ground." },
            { id: 'p3s2q4', question: "æˆ‘è§‰å¾—å’Œæœ‹å‹ä¸€èµ·ç©ï¼ˆã€€ï¼‰ã€‚", options: ["æ›´å¥½ç©", "æ›´ç´¯", "æ›´æ…¢"], correctAnswer: "æ›´å¥½ç©", 
              explanation: "å’Œæœ‹å‹ä¸€èµ·ç©é€šå¸¸æ˜¯å¼€å¿ƒçš„äº‹ï¼Œæ‰€ä»¥æ˜¯â€œæ›´å¥½ç©â€ã€‚", 
              annotatedSentence: `<span class="word-anno">å’Œ<span class="pinyin">hÃ©</span></span><span class="word-anno">æœ‹å‹<span class="pinyin">pÃ©ng you</span></span><span class="word-anno">ä¸€èµ·<span class="pinyin">yÄ« qÇ</span></span><span class="word-anno">ç©<span class="pinyin">wÃ¡n</span></span><span class="word-anno">æ›´å¥½ç©<span class="pinyin">gÃ¨ng hÇo wÃ¡n</span></span>`, 
              englishExplanation: "English: 'æ›´å¥½ç©' (gÃ¨ng hÇo wÃ¡n) means 'more fun'. Playing with friends is usually more fun than playing alone." },
            { id: 'p3s2q5', question: "ï¼ˆã€€ï¼‰å»å…¬å›­ï¼Œå¥½å—ï¼Ÿ", options: ["æˆ‘è·Ÿä½ ", "ä»–è‡ªå·±", "è€å¸ˆä»¬"], correctAnswer: "æˆ‘è·Ÿä½ ", 
              explanation: "è¿™æ˜¯ä¸€ä¸ªé‚€è¯·ï¼Œæ‰€ä»¥ç”¨â€œæˆ‘è·Ÿä½ â€æ¥é—®å¯¹æ–¹ã€‚", 
              annotatedSentence: `<span class="word-anno">æˆ‘è·Ÿä½ <span class="pinyin">wÇ’ gÄ“n nÇ</span></span><span class="word-anno">å»<span class="pinyin">qÃ¹</span></span><span class="word-anno">å…¬å›­<span class="pinyin">gÅng yuÃ¡n</span></span><span class="word-anno">ï¼Œå¥½å—<span class="pinyin">hÇo ma</span></span>`, 
              englishExplanation: "English: 'æˆ‘è·Ÿä½ ' (wÇ’ gÄ“n nÇ) - 'Me and you' - is used here to make an invitation to someone." },
            { id: 'p3s2q6', question: "æˆ‘ä»æ¥æ²¡æœ‰ï¼ˆã€€ï¼‰çœŸçš„å¤§è±¡ã€‚", options: ["çœ‹è¿‡", "åšè¿‡", "ç©è¿‡"], correctAnswer: "çœ‹è¿‡", 
              explanation: "å¤§è±¡æ˜¯åŠ¨ç‰©ï¼Œæˆ‘ä»¬æ˜¯ç”¨çœ¼ç›â€œçœ‹è¿‡â€å®ƒã€‚", 
              annotatedSentence: `<span class="word-anno">æˆ‘<span class="pinyin">wÇ’</span></span><span class="word-anno">æ²¡æœ‰<span class="pinyin">mÃ©i yÇ’u</span></span><span class="word-anno">çœ‹è¿‡<span class="pinyin">kÃ n guo</span></span><span class="word-anno">çœŸçš„<span class="pinyin">zhÄ“n de</span></span><span class="word-anno">å¤§è±¡<span class="pinyin">dÃ  xiÃ ng</span></span>`, 
              englishExplanation: "English: 'çœ‹è¿‡' (kÃ n guo) means 'have seen'. You see an animal like an elephant." },
            { id: 'p3s2q7', question: "å¤§å®¶ä¸€èµ·ï¼ˆã€€ï¼‰ï¼ŒçœŸå¼€å¿ƒï¼", options: ["è·³é£æœº", "å†™åŠŸè¯¾", "è€ƒè¯•"], correctAnswer: "è·³é£æœº", 
              explanation: "è·³é£æœºæ˜¯ä¸€ç§å¼€å¿ƒçš„æ¸¸æˆã€‚", 
              annotatedSentence: `<span class="word-anno">å¤§å®¶<span class="pinyin">dÃ  jiÄ</span></span><span class="word-anno">ä¸€èµ·<span class="pinyin">yÄ« qÇ</span></span><span class="word-anno">è·³é£æœº<span class="pinyin">tiÃ o fÄ“i jÄ«</span></span><span class="word-anno">ï¼ŒçœŸ<span class="pinyin">zhÄ“n</span></span><span class="word-anno">å¼€å¿ƒ<span class="pinyin">kÄi xÄ«n</span></span>`, 
              englishExplanation: "English: 'è·³é£æœº' (hopscotch) is a game, which fits the context of being happy (å¼€å¿ƒ)." },
            { id: 'p3s2q8', question: "ä¸€ä¸ªäººç©å¾ˆæ²¡æ„æ€ï¼Œä¸€èµ·ç©ï¼ˆã€€ï¼‰ã€‚", options: ["æ›´å¥½ç©", "å¾ˆéº»çƒ¦", "ä¸å¼€å¿ƒ"], correctAnswer: "æ›´å¥½ç©", 
              explanation: "â€œæ›´å¥½ç©â€å’Œå‰é¢çš„â€œå¾ˆæ²¡æ„æ€â€æ˜¯ç›¸åçš„ï¼Œæœ€åˆé€‚ã€‚", 
              annotatedSentence: `<span class="word-anno">ä¸€èµ·<span class="pinyin">yÄ« qÇ</span></span><span class="word-anno">ç©<span class="pinyin">wÃ¡n</span></span><span class="word-anno">æ›´å¥½ç©<span class="pinyin">gÃ¨ng hÇo wÃ¡n</span></span>`, 
              englishExplanation: "English: 'æ›´å¥½ç©' (more fun) is the logical contrast to playing alone being boring (æ²¡æ„æ€)." },
            { id: 'p3s2q9', question: "æˆ‘å–œæ¬¢ï¼ˆã€€ï¼‰ï¼Œä¹Ÿå–œæ¬¢è·³èˆã€‚", options: ["å”±æ­Œ", "åµæ¶", "å“­"], correctAnswer: "å”±æ­Œ", 
              explanation: "å”±æ­Œå’Œè·³èˆéƒ½æ˜¯æ‰è‰ºè¡¨æ¼”ï¼Œæ˜¯å¥½çš„çˆ±å¥½ã€‚", 
              annotatedSentence: `<span class="word-anno">æˆ‘<span class="pinyin">wÇ’</span></span><span class="word-anno">å–œæ¬¢<span class="pinyin">xÇ huan</span></span><span class="word-anno">å”±æ­Œ<span class="pinyin">chÃ ng gÄ“</span></span>`, 
              englishExplanation: "English: 'å”±æ­Œ' (chÃ ng gÄ“ - to sing) is a positive hobby, similar to dancing (è·³èˆ)." },
            { id: 'p3s2q10', question: "ä½ ï¼ˆã€€ï¼‰è€å¸ˆä»Šå¤©ç©¿äº†æ–°è¡£æœå—ï¼Ÿ", options: ["çœ‹åˆ°", "çŸ¥é“", "å¬åˆ°"], correctAnswer: "çœ‹åˆ°", 
              explanation: "è¡£æœæ˜¯ç”¨çœ¼ç›â€œçœ‹åˆ°â€çš„ã€‚", 
              annotatedSentence: `<span class="word-anno">ä½ <span class="pinyin">nÇ</span></span><span class="word-anno">çœ‹åˆ°<span class="pinyin">kÃ n dÃ o</span></span><span class="word-anno">è€å¸ˆ<span class="pinyin">lÇo shÄ«</span></span><span class="word-anno">ç©¿äº†<span class="pinyin">chuÄn le</span></span><span class="word-anno">æ–°è¡£æœ<span class="pinyin">xÄ«n yÄ« fu</span></span><span class="word-anno">å—<span class="pinyin">ma</span></span>`, 
              englishExplanation: "English: 'çœ‹åˆ°' (kÃ n dÃ o) means 'to see'. You use your eyes to see the teacher's new clothes." },
            { id: 'p3s2q11', question: "ï¼ˆã€€ï¼‰ä¸€èµ·å»å›¾ä¹¦é¦†ï¼Œå¯ä»¥å—ï¼Ÿ", options: ["æˆ‘è·Ÿä½ ", "ä»–ä»¬", "å¥¹å’Œå¼Ÿå¼Ÿ"], correctAnswer: "æˆ‘è·Ÿä½ ", 
              explanation: "è¿™æ˜¯åœ¨é‚€è¯·å¯¹æ–¹ï¼Œæ‰€ä»¥ç”¨â€œæˆ‘è·Ÿä½ â€ã€‚", 
              annotatedSentence: `<span class="word-anno">æˆ‘è·Ÿä½ <span class="pinyin">wÇ’ gÄ“n nÇ</span></span><span class="word-anno">ä¸€èµ·<span class="pinyin">yÄ« qÇ</span></span><span class="word-anno">å»<span class="pinyin">qÃ¹</span></span><span class="word-anno">å›¾ä¹¦é¦†<span class="pinyin">tÃº shÅ« guÇn</span></span>`, 
              englishExplanation: "English: 'æˆ‘è·Ÿä½ ' (me and you) is used to personally invite someone to go to the library." },
            { id: 'p3s2q12', question: "æ­ç§¯æœ¨æ¯”çœ‹ç”µè§†ï¼ˆã€€ï¼‰ã€‚", options: ["æ›´å¥½ç©", "æ›´ç®€å•", "æ›´åµ"], correctAnswer: "æ›´å¥½ç©", 
              explanation: "â€œæ›´å¥½ç©â€è¡¨ç¤ºä½ æ›´å–œæ¬¢æ­ç§¯æœ¨è¿™ä¸ªæ´»åŠ¨ã€‚", 
              annotatedSentence: `<span class="word-anno">æ­ç§¯æœ¨<span class="pinyin">dÄ jÄ« mÃ¹</span></span><span class="word-anno">æ¯”<span class="pinyin">bÇ</span></span><span class="word-anno">çœ‹ç”µè§†<span class="pinyin">kÃ n diÃ n shÃ¬</span></span><span class="word-anno">æ›´å¥½ç©<span class="pinyin">gÃ¨ng hÇo wÃ¡n</span></span>`, 
              englishExplanation: "English: 'æ›´å¥½ç©' (more fun) is used to compare two activities and state a preference." },
        ],
        "ç¬¬ä¸‰ç»„ï¼šè¯´ä¸€è¯´ (Application)": [
            { id: 'p3s3q1', question: "æœ‹å‹é€ç»™ä½ ç¤¼ç‰©ï¼Œä½ åº”è¯¥è¯´ä»€ä¹ˆï¼Ÿ", options: ["è°¢è°¢ä½ ï¼", "å¯¹ä¸èµ·ã€‚", "ä½ æ—©ã€‚"], correctAnswer: "è°¢è°¢ä½ ï¼", 
              explanation: "æ”¶åˆ°ç¤¼ç‰©æ—¶ï¼Œè¦æœ‰ç¤¼è²Œåœ°è¯´â€œè°¢è°¢â€ã€‚", 
              annotatedSentence: `<span class="word-anno">æœ‹å‹<span class="pinyin">pÃ©ng you</span></span><span class="word-anno">é€<span class="pinyin">sÃ²ng</span></span><span class="word-anno">ç¤¼ç‰©<span class="pinyin">lÇ wÃ¹</span></span><span class="word-anno">ï¼Œä½ <span class="pinyin">nÇ</span></span><span class="word-anno">è¯´<span class="pinyin">shuÅ</span></span><span class="word-anno">è°¢è°¢ä½ <span class="pinyin">xiÃ¨ xie nÇ</span></span>`, 
              englishExplanation: "English: When you receive a gift (ç¤¼ç‰©), the polite response is 'Thank you!' (è°¢è°¢ä½ ï¼)." },
            { id: 'p3s3q2', question: "å°æ˜è¯´ï¼šâ€œæˆ‘ä»¬ä¸‰ä¸ªäººä¸€èµ·ç©å§ï¼â€ ä½ å¯ä»¥å›ç­”ï¼š", options: ["â€œå¥½å•Šï¼ä¸‰ä¸ªäººç©æ›´å¿«ä¸œï¼â€", "â€œæˆ‘ä¸è¦ã€‚â€", "â€œä½ æ˜¯è°ï¼Ÿâ€"], correctAnswer: "â€œå¥½å•Šï¼ä¸‰ä¸ªäººç©æ›´å¿«ä¸œï¼â€", 
              explanation: "è¿™æ˜¯ä¸€ä¸ªåŒæ„çš„å›ç­”ï¼Œè¡¨ç¤ºä½ å¾ˆå¼€å¿ƒèƒ½å’Œå¤§å®¶ä¸€èµ·ç©ã€‚ï¼ˆâ€œä¸œâ€åº”ä¸ºâ€œä¹â€)", 
              annotatedSentence: `<span class="word-anno">ä¸‰ä¸ªäºº<span class="pinyin">sÄn gÃ¨ rÃ©n</span></span><span class="word-anno">ç©<span class="pinyin">wÃ¡n</span></span><span class="word-anno">æ›´<span class="pinyin">gÃ¨ng</span></span><span class="word-anno">å¿«ä¹<span class="pinyin">kuÃ i lÃ¨</span></span>`, 
              englishExplanation: "English: This means 'It's more fun with three people!'. It's a positive reply to an invitation to play. (Note: The original 'ä¸œ' is likely a typo for 'ä¹' lÃ¨)." },
            { id: 'p3s3q3', question: "ä»Šå¤©æ˜¯ä½ çš„ç”Ÿæ—¥ï¼Œå¦ˆå¦ˆé—®ï¼šâ€œä½ å¼€å¿ƒå—ï¼Ÿâ€ ä½ ä¼šå›ç­”ï¼š", options: ["â€œæˆ‘å¾ˆå¼€å¿ƒï¼â€", "â€œæˆ‘å¾ˆç´¯ã€‚â€", "â€œæˆ‘ä¸çŸ¥é“ã€‚â€"], correctAnswer: "â€œæˆ‘å¾ˆå¼€å¿ƒï¼â€", 
              explanation: "ç”Ÿæ—¥æ˜¯ä¸€ä»¶å¼€å¿ƒçš„äº‹ï¼Œæ‰€ä»¥å›ç­”â€œæˆ‘å¾ˆå¼€å¿ƒï¼â€æœ€åˆé€‚ã€‚", 
              annotatedSentence: `<span class="word-anno">å¦ˆå¦ˆ<span class="pinyin">mÄ ma</span></span><span class="word-anno">é—®<span class="pinyin">wÃ¨n</span></span><span class="word-anno">ï¼šä½ <span class="pinyin">nÇ</span></span><span class="word-anno">å¼€å¿ƒ<span class="pinyin">kÄi xÄ«n</span></span><span class="word-anno">å—<span class="pinyin">ma</span></span><span class="word-anno">ï¼Ÿ å›ç­”<span class="pinyin">huÃ­ dÃ¡</span></span><span class="word-anno">ï¼šæˆ‘<span class="pinyin">wÇ’</span></span><span class="word-anno">å¾ˆ<span class="pinyin">hÄ›n</span></span><span class="word-anno">å¼€å¿ƒ<span class="pinyin">kÄi xÄ«n</span></span>`, 
              englishExplanation: "English: 'ä½ å¼€å¿ƒå—ï¼Ÿ' (nÇ kÄi xÄ«n ma?) means 'Are you happy?'. A natural response on your birthday is 'I am very happy!' (æˆ‘å¾ˆå¼€å¿ƒï¼)." },
            { id: 'p3s3q4', question: "ä½ ä¸å°å¿ƒæ’åˆ°äº†åŒå­¦ï¼Œåº”è¯¥è¯´ä»€ä¹ˆï¼Ÿ", options: ["å¯¹ä¸èµ·ã€‚", "è°¢è°¢ä½ ã€‚", "æ²¡å…³ç³»ã€‚"], correctAnswer: "å¯¹ä¸èµ·ã€‚", 
              explanation: "åšé”™äº†äº‹æˆ–è€…ç»™åˆ«äººå¸¦æ¥éº»çƒ¦ï¼Œè¦è¯´â€œå¯¹ä¸èµ·â€ã€‚", 
              annotatedSentence: `<span class="word-anno">æ’åˆ°<span class="pinyin">zhuÃ ng dÃ o</span></span><span class="word-anno">åŒå­¦<span class="pinyin">tÃ³ng xuÃ©</span></span><span class="word-anno">ï¼Œè¯´<span class="pinyin">shuÅ</span></span><span class="word-anno">å¯¹ä¸èµ·<span class="pinyin">duÃ¬ bu qÇ</span></span>`, 
              englishExplanation: "English: If you accidentally bump into someone, you should say 'I'm sorry' (å¯¹ä¸èµ·)." },
            { id: 'p3s3q5', question: "åŒå­¦å¯¹ä½ è¯´äº†â€œè°¢è°¢â€ï¼Œä½ åº”è¯¥å›ç­”ï¼š", options: ["ä¸å®¢æ°”ã€‚", "å†è§ã€‚", "ä½ å¥½ã€‚"], correctAnswer: "ä¸å®¢æ°”ã€‚", 
              explanation: "â€œä¸å®¢æ°”â€æ˜¯å›ç­”â€œè°¢è°¢â€æ—¶çš„ç¤¼è²Œç”¨è¯­ã€‚", 
              annotatedSentence: `<span class="word-anno">å›ç­”<span class="pinyin">huÃ­ dÃ¡</span></span><span class="word-anno">è°¢è°¢<span class="pinyin">xiÃ¨ xie</span></span><span class="word-anno">ï¼Œç”¨<span class="pinyin">yÃ²ng</span></span><span class="word-anno">ä¸å®¢æ°”<span class="pinyin">bÃº kÃ¨ qi</span></span>`, 
              englishExplanation: "English: The standard reply to 'Thank you' (è°¢è°¢) is 'You're welcome' (ä¸å®¢æ°”)." },
            { id: 'p3s3q6', question: "è€å¸ˆé—®ï¼šâ€œä½ ä¸ºä»€ä¹ˆè¿Ÿåˆ°äº†ï¼Ÿâ€ ä½ å¯ä»¥å›ç­”ï¼š", options: ["â€œå› ä¸ºæˆ‘ç¡è¿‡å¤´äº†ã€‚â€", "â€œæˆ‘ä¸çŸ¥é“ã€‚â€", "â€œè°¢è°¢è€å¸ˆã€‚â€"], correctAnswer: "â€œå› ä¸ºæˆ‘ç¡è¿‡å¤´äº†ã€‚â€", 
              explanation: "â€œå› ä¸ºâ€æ˜¯ç”¨æ¥è§£é‡ŠåŸå› çš„ã€‚", 
              annotatedSentence: `<span class="word-anno">ä¸ºä»€ä¹ˆ<span class="pinyin">wÃ¨i shÃ©n me</span></span><span class="word-anno">è¿Ÿåˆ°<span class="pinyin">chÃ­ dÃ o</span></span><span class="word-anno">äº†<span class="pinyin">le</span></span><span class="word-anno">ï¼Ÿ å› ä¸º<span class="pinyin">yÄ«n wÃ¨i</span></span><span class="word-anno">...</span>`, 
              englishExplanation: "English: 'ä¸ºä»€ä¹ˆ' (wÃ¨i shÃ©n me) asks 'Why?'. The answer should start with 'å› ä¸º' (yÄ«n wÃ¨i), which means 'because'." },
            { id: 'p3s3q7', question: "å°ä¸½é‚€è¯·ä½ ç©ï¼Œä½ å¾ˆé«˜å…´ã€‚ä½ ä¼šæ€ä¹ˆè¯´ï¼Ÿ", options: ["â€œå¤ªå¥½äº†ï¼â€", "â€œæˆ‘ä¸è¦ã€‚â€", "â€œä½ å¥½å—ï¼Ÿâ€"], correctAnswer: "â€œå¤ªå¥½äº†ï¼â€", 
              explanation: "â€œå¤ªå¥½äº†ï¼â€è¡¨ç¤ºä½ éå¸¸å¼€å¿ƒå’Œæ„¿æ„ã€‚", 
              annotatedSentence: `<span class="word-anno">ä½ <span class="pinyin">nÇ</span></span><span class="word-anno">å¾ˆé«˜å…´<span class="pinyin">hÄ›n gÄo xÃ¬ng</span></span><span class="word-anno">ï¼Œè¯´<span class="pinyin">shuÅ</span></span><span class="word-anno">å¤ªå¥½äº†<span class="pinyin">tÃ i hÇo le</span></span>`, 
              englishExplanation: "English: 'å¤ªå¥½äº†ï¼' (tÃ i hÇo le!) means 'Great!' or 'That's wonderful!'. It expresses excitement." },
            { id: 'p3s3q8', question: "ä½ æƒ³é—®æœ‹å‹å¼€ä¸å¼€å¿ƒï¼Œåº”è¯¥æ€ä¹ˆé—®ï¼Ÿ", options: ["ä½ å¼€å¿ƒå—ï¼Ÿ", "ä½ å«ä»€ä¹ˆï¼Ÿ", "ä½ å‡ å²äº†ï¼Ÿ"], correctAnswer: "ä½ å¼€å¿ƒå—ï¼Ÿ", 
              explanation: "â€œä½ å¼€å¿ƒå—ï¼Ÿâ€æ˜¯ç›´æ¥é—®åˆ«äººå¿ƒæƒ…å¥½ä¸å¥½çš„é—®å¥ã€‚", 
              annotatedSentence: `<span class="word-anno">é—®<span class="pinyin">wÃ¨n</span></span><span class="word-anno">ï¼šä½ <span class="pinyin">nÇ</span></span><span class="word-anno">å¼€å¿ƒ<span class="pinyin">kÄi xÄ«n</span></span><span class="word-anno">å—<span class="pinyin">ma</span></span><span class="word-anno">ï¼Ÿ</span>`, 
              englishExplanation: "English: To ask 'Are you happy?', you say 'ä½ å¼€å¿ƒå—ï¼Ÿ' (nÇ kÄi xÄ«n ma?)." },
            { id: 'p3s3q9', question: "å°åè¯´ï¼šâ€œæˆ‘ä»¬ä¸€èµ·ç©æ–¹å—å§ï¼â€ ä½ åŒæ„äº†ï¼Œä¼šè¯´ï¼š", options: ["â€œå¥½å•Šï¼â€", "â€œå¯¹ä¸èµ·ã€‚â€", "â€œå†è§ã€‚â€"], correctAnswer: "â€œå¥½å•Šï¼â€", 
              explanation: "â€œå¥½å•Šï¼â€è¡¨ç¤ºä½ åŒæ„äº†æœ‹å‹çš„é‚€è¯·ã€‚", 
              annotatedSentence: `<span class="word-anno">åŒæ„<span class="pinyin">tÃ³ng yÃ¬</span></span><span class="word-anno">äº†<span class="pinyin">le</span></span><span class="word-anno">ï¼Œè¯´<span class="pinyin">shuÅ</span></span><span class="word-anno">å¥½å•Š<span class="pinyin">hÇo a</span></span>`, 
              englishExplanation: "English: 'å¥½å•Šï¼' (hÇo a!) is a positive and common way to say 'Okay!' or 'Sure!' when agreeing to a suggestion." },
            { id: 'p3s3q10', question: "å½“åˆ«äººå¸®åŠ©äº†ä½ ï¼Œä½ åº”è¯¥è¯´ä»€ä¹ˆï¼Ÿ", options: ["è°¢è°¢ä½ ã€‚", "å¯¹ä¸èµ·ã€‚", "ä¸å®¢æ°”ã€‚"], correctAnswer: "è°¢è°¢ä½ ã€‚", 
              explanation: "å¾—åˆ°åˆ«äººçš„å¸®åŠ©åï¼Œè¦è¯´â€œè°¢è°¢ä½ â€æ¥è¡¨ç¤ºæ„Ÿè°¢ã€‚", 
              annotatedSentence: `<span class="word-anno">åˆ«äºº<span class="pinyin">biÃ© rÃ©n</span></span><span class="word-anno">å¸®åŠ©<span class="pinyin">bÄng zhÃ¹</span></span><span class="word-anno">äº†<span class="pinyin">le</span></span><span class="word-anno">ä½ <span class="pinyin">nÇ</span></span><span class="word-anno">ï¼Œè¯´<span class="pinyin">shuÅ</span></span><span class="word-anno">è°¢è°¢ä½ <span class="pinyin">xiÃ¨ xie nÇ</span></span>`, 
              englishExplanation: "English: When someone helps you, you should say 'Thank you' (è°¢è°¢ä½ )." },
            { id: 'p3s3q11', question: "ä½ çœ‹åˆ°æœ‹å‹åœ¨ç©ä¸€ä¸ªæ–°æ¸¸æˆï¼Œä½ æƒ³çŸ¥é“å¥½ä¸å¥½ç©ï¼Œå¯ä»¥é—®ï¼š", options: ["è¿™ä¸ªæ¸¸æˆå¥½ç©å—ï¼Ÿ", "ä½ åœ¨åƒä»€ä¹ˆï¼Ÿ", "è¿™æ˜¯è°çš„ä¹¦ï¼Ÿ"], correctAnswer: "è¿™ä¸ªæ¸¸æˆå¥½ç©å—ï¼Ÿ", 
              explanation: "è¿™ä¸ªé—®é¢˜æ˜¯ç›´æ¥é—®æ¸¸æˆæ˜¯ä¸æ˜¯å¥½ç©ã€‚", 
              annotatedSentence: `<span class="word-anno">è¿™ä¸ª<span class="pinyin">zhÃ¨ ge</span></span><span class="word-anno">æ¸¸æˆ<span class="pinyin">yÃ³u xÃ¬</span></span><span class="word-anno">å¥½ç©<span class="pinyin">hÇo wÃ¡n</span></span><span class="word-anno">å—<span class="pinyin">ma</span></span><span class="word-anno">ï¼Ÿ</span>`, 
              englishExplanation: "English: To ask if a game is fun, you can say 'è¿™ä¸ªæ¸¸æˆå¥½ç©å—ï¼Ÿ' (zhÃ¨ ge yÃ³u xÃ¬ hÇo wÃ¡n ma?)." },
            { id: 'p3s3q12', question: "å¦‚æœåªæœ‰ä¸€ä¸ªç©å…·ï¼Œä½†ä¸¤ä¸ªäººéƒ½æƒ³ç©ï¼Œå¯ä»¥è¯´ï¼š", options: ["â€œæˆ‘ä»¬è½®æµç©å§ã€‚â€", "â€œè¿™æ˜¯æˆ‘çš„ï¼â€", "â€œæˆ‘ä¸ç©äº†ã€‚â€"], correctAnswer: "â€œæˆ‘ä»¬è½®æµç©å§ã€‚â€", 
              explanation: "â€œè½®æµç©â€æ˜¯ä¸€ä¸ªåˆ†äº«å’Œè§£å†³é—®é¢˜çš„å¥½åŠæ³•ã€‚", 
              annotatedSentence: `<span class="word-anno">æˆ‘ä»¬<span class="pinyin">wÇ’ men</span></span><span class="word-anno">è½®æµ<span class="pinyin">lÃºn liÃº</span></span><span class="word-anno">ç©å§<span class="pinyin">wÃ¡n ba</span></span>`, 
              englishExplanation: "English: 'æˆ‘ä»¬è½®æµç©å§' (wÇ’ men lÃºn liÃº wÃ¡n ba) means 'Let's take turns playing'. This is a good way to share." }
        ]
    };

    // --- State Variables ---
    let currentSetData = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let incorrectAnswers = [];
    let startTime;
    let endTime;
    let isRedoing = false;
    let proceedTimeoutId = null;
    let isWaitingToProceed = false;
    let userName = localStorage.getItem(USER_NAME_STORAGE_KEY) || '';

    // --- Sound Synthesis (Tone.js) ---
    const correctSound = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.05, release: 0.2 }, }).toDestination();
    const incorrectSound = new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 } }).toDestination();

    // --- Confetti ---
    const confettiCanvas = document.getElementById('confettiCanvas');
    const myConfetti = confetti.create(confettiCanvas, { resize: true, useWorker: true });

    // --- DOM Elements ---
    const nameModal = document.getElementById('nameModal');
    const userNameInput = document.getElementById('userNameInput');
    const setSelectionScreen = document.getElementById('setSelectionScreen');
    const setButtonsContainer = document.getElementById('setButtonsContainer');
    const flashcardScreen = document.getElementById('flashcardScreen');
    const resultsScreen = document.getElementById('resultsScreen');
    const progressText = document.getElementById('progressText');
    const progressBarFill = document.getElementById('progressBarFill');
    const flashcard = document.getElementById('flashcard');
    const questionText = document.getElementById('questionText');
    const feedbackText = document.getElementById('feedbackText');
    const feedbackIconContainer = document.getElementById('feedbackIconContainer');
    const continueText = document.getElementById('continueText');
    const choiceButtons = [ document.getElementById('choice1'), document.getElementById('choice2'), document.getElementById('choice3') ];
    const scoreDisplayEl = document.getElementById('scoreDisplay');
    const percentageEl = document.getElementById('percentage');
    const timeTakenEl = document.getElementById('timeTaken');
    const incorrectListContainer = document.getElementById('incorrectListContainer');
    const incorrectList = document.getElementById('incorrectList');
    const noIncorrectText = document.getElementById('noIncorrectText');
    const redoIncorrectButton = document.getElementById('redoIncorrectButton');
    const encouragementTextEl = document.getElementById('encouragementText');
    const resultsHeadingEl = document.getElementById('resultsHeading');
    const raceTrackContainer = document.querySelector('#resultsScreen .race-track-container');
    const raceTrackFillEl = document.getElementById('raceTrackFill');
    const rocketEl = document.getElementById('rocketEl');

    // --- Event Listeners ---
    flashcard.addEventListener('click', () => {
        if (isWaitingToProceed &&
            !flashcard.classList.contains('incorrect-state') &&
            (flashcard.classList.contains('correct-state-static') || flashcard.classList.contains('clickable-card'))) {
            proceedToNext();
        }
    });
    userNameInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            saveUserName();
        }
    });

    // --- Utility Functions ---
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // --- Core Application Logic ---
    function populateStartButton() {
        setButtonsContainer.innerHTML = '';
        Object.keys(allFlashcardSets).forEach(setName => {
            const set = allFlashcardSets[setName];
            if (set.length > 0) { // Check if set is not empty
                const button = document.createElement('button');
                button.textContent = `å¼€å§‹ ${setName}`;
                button.className = `action-button w-full py-4 px-6 bg-blue-500 hover:bg-blue-600 text-white mb-3 last:mb-0 text-lg`; 
                button.onclick = () => startFlashcardSession(set, setName);
                setButtonsContainer.appendChild(button);
            }
        });
    }

    function saveUserName() {
        const name = userNameInput.value.trim();
        userName = name ? name : 'å°æœ‹å‹';
        localStorage.setItem(USER_NAME_STORAGE_KEY, userName);
        nameModal.style.display = 'none';
        showSetSelection();
    }

    function startFlashcardSession(selectedSet, setName) {
        Tone.start().catch(e => console.warn("Audio context could not start:", e));
        let fullSetCopy = [...selectedSet]; 
        shuffleArray(fullSetCopy);
        currentSetData = fullSetCopy.slice(0, Math.min(fullSetCopy.length, QUESTIONS_PER_SET)); 
        currentSetData.setName = setName; 
        currentQuestionIndex = 0;
        score = 0;
        incorrectAnswers = [];
        isRedoing = false;
        setSelectionScreen.classList.add('hidden');
        resultsScreen.classList.add('hidden');
        flashcardScreen.classList.remove('hidden');
        updateProgress(); 
        startTime = new Date();
        displayQuestion();
    }

    function resetCardState() {
        if (proceedTimeoutId) { clearTimeout(proceedTimeoutId); proceedTimeoutId = null; }
        isWaitingToProceed = false;
        flashcard.classList.remove('shake', 'correct-state-static', 'incorrect-state', 'clickable-card');
        questionText.classList.remove('hidden');
        feedbackText.innerHTML = '';
        feedbackIconContainer.classList.add('hidden');
        continueText.classList.add('hidden');
        choiceButtons.forEach(btn => {
            btn.className = 'choice-button bg-slate-100 hover:bg-slate-200 text-slate-700';
        });
    }

    function displayQuestion() {
        resetCardState();
        if (currentQuestionIndex >= currentSetData.length) {
            showResults();
            return;
        }
        const questionData = currentSetData[currentQuestionIndex];
        questionText.innerHTML = questionData.question.replace(/\n/g, '<br>');
        let displayOptions = [...questionData.options];
        shuffleArray(displayOptions);
        choiceButtons.forEach((button, index) => {
            if (displayOptions[index] !== undefined) {
                button.textContent = displayOptions[index];
                button.disabled = false;
                button.dataset.answer = displayOptions[index];
                button.onclick = () => checkAnswer(button);
                button.style.display = 'flex';
            } else {
                button.style.display = 'none'; 
            }
        });
    }

    function updateProgress() {
        const totalQuestions = currentSetData.length;
        const completed = currentQuestionIndex;
        const progressPercentage = totalQuestions > 0 ? (completed / totalQuestions) * 100 : 0;
        progressText.textContent = `${completed} / ${totalQuestions}`;
        progressBarFill.style.width = `${progressPercentage}%`;
    }

    function checkAnswer(button) {
        Tone.start().catch(e => console.warn("Audio context failed:", e));
        if (isWaitingToProceed && !flashcard.classList.contains('incorrect-state')) return;
        const selectedAnswer = button.dataset.answer;
        const questionData = currentSetData[currentQuestionIndex];
        const correctAnswer = questionData.correctAnswer;
        choiceButtons.forEach(btn => btn.disabled = true);

        if (selectedAnswer === correctAnswer) {
            if (!isRedoing) score++;
            flashcard.classList.add('correct-state-static');
            feedbackIconContainer.innerHTML = '<span class="text-7xl md:text-8xl">âœ“</span>';
            feedbackIconContainer.classList.remove('hidden');
            questionText.classList.add('hidden');
            feedbackText.textContent = 'æ­£ç¡®!';
            myConfetti({ particleCount: 120, spread: 80, origin: { y: 0.6 } });
            correctSound.triggerAttackRelease("G5", "8n", Tone.now());
            button.className = 'choice-button bg-emerald-600 text-white ring-2 ring-emerald-800 shadow-md';
            isWaitingToProceed = true;
            flashcard.classList.add('clickable-card');
            continueText.classList.remove('hidden');
            proceedTimeoutId = setTimeout(proceedToNext, AUTO_PROCEED_DELAY);
            currentQuestionIndex++; 
            updateProgress(); 
        } else {
            flashcard.classList.add('shake', 'incorrect-state');
            feedbackIconContainer.innerHTML = '<span class="text-7xl md:text-8xl">âœ—</span>';
            feedbackIconContainer.classList.remove('hidden');
            questionText.classList.add('hidden'); 
            
            const annotatedSentence = questionData.annotatedSentence.replace('ï¼ˆã€€ï¼‰', `<span class="word-anno" style="color:#fde047;">${correctAnswer}</span>`);
            const englishExplanation = questionData.englishExplanation || "";
            const chineseExplanation = questionData.explanation || "æ²¡æœ‰è§£æã€‚";
            
            feedbackText.innerHTML = `
                <div class="annotated-sentence-container">${annotatedSentence}</div>
                <div class="english-explanation">${englishExplanation}</div>
                <div class="explanation-box"><b>ä¸­æ–‡è§£æ:</b> ${chineseExplanation}</div>
                <div class="prompt-guidance">ç‚¹å‡»ç»¿è‰²æ­£ç¡®ç­”æ¡ˆç»§ç»­ã€‚</div>
            `;

            incorrectSound.triggerAttackRelease("C3", "8n");
            if (!isRedoing) {
                incorrectAnswers.push({ questionData: questionData, userAnswer: selectedAnswer });
            }
            isWaitingToProceed = false;
            flashcard.classList.remove('clickable-card');
            if (proceedTimeoutId) { clearTimeout(proceedTimeoutId); }
            choiceButtons.forEach(btn => {
                if (btn.dataset.answer === correctAnswer) {
                    btn.className = 'choice-button bg-emerald-500 hover:bg-emerald-600 text-white';
                    btn.disabled = false;
                    btn.onclick = function() {
                        currentQuestionIndex++; 
                        updateProgress(); 
                        proceedToNext();
                    };
                } else if (btn === button) {
                    btn.className = 'choice-button bg-red-700 text-white ring-2 ring-red-900 shadow-md';
                } else {
                    btn.className = 'choice-button bg-slate-200 text-slate-500 forced-disabled-look';
                }
            });
        }
    }

    function proceedToNext() {
        if (proceedTimeoutId) { clearTimeout(proceedTimeoutId); }
        isWaitingToProceed = false;
        displayQuestion();
    }

    function showResults() {
        endTime = new Date();
        const timeDiff = Math.round((endTime - startTime) / 1000);
        const totalQuestions = currentSetData.length;
        const currentScore = isRedoing ? (totalQuestions - incorrectAnswers.length) : score;
        const percentage = totalQuestions > 0 ? Math.round((currentScore / totalQuestions) * 100) : 0;

        resultsHeadingEl.textContent = isRedoing ? 'é”™é¢˜å¤ä¹ å®Œæˆï¼' : `â€œ${currentSetData.setName || 'ç»ƒä¹ '}â€å®Œæˆ!`;
        scoreDisplayEl.textContent = `${currentScore} / ${totalQuestions}`;
        percentageEl.textContent = `${percentage}`;
        timeTakenEl.textContent = `${timeDiff}`;

        if (percentage === 100) encouragementTextEl.textContent = "å¤ªæ£’äº†ï¼Œä½ æ˜¯ç¬¬ä¸€åï¼";
        else if (percentage >= 70) encouragementTextEl.textContent = "åšå¾—å¾ˆå¥½ï¼ç»§ç»­åŠ æ²¹ï¼";
        else encouragementTextEl.textContent = "ä¸é”™ï¼å†è¯•ä¸€æ¬¡ä¼šæ›´å¥½ï¼";
        
        flashcardScreen.classList.add('hidden');
        resultsScreen.classList.remove('hidden');
        
        requestAnimationFrame(() => {
            setTimeout(() => { 
                const trackWidth = raceTrackContainer.offsetWidth;
                const effectiveTrackWidth = trackWidth - rocketEl.offsetWidth; 
                const finalRocketPosition = Math.max(0, (percentage / 100) * effectiveTrackWidth);
                rocketEl.style.left = `${finalRocketPosition}px`;
                raceTrackFillEl.style.width = `${finalRocketPosition}px`;
            }, 100);
        });

        incorrectList.innerHTML = '';
        if (incorrectAnswers.length > 0) {
            incorrectListContainer.classList.remove('hidden'); noIncorrectText.classList.add('hidden');
            incorrectAnswers.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<b>é—®é¢˜:</b> ${item.questionData.question.replace(/\n/g, ' ')}<br/><b>ä½ çš„ç­”æ¡ˆ:</b> <span class="text-red-500">${item.userAnswer}</span><br/><b>æ­£ç¡®ç­”æ¡ˆ:</b> <span class="text-emerald-600">${item.questionData.correctAnswer}</span>`;
                incorrectList.appendChild(li);
            });
            redoIncorrectButton.classList.remove('hidden');
            redoIncorrectButton.disabled = isRedoing || incorrectAnswers.length === 0;
        } else {
            incorrectListContainer.classList.add('hidden'); noIncorrectText.classList.remove('hidden');
            redoIncorrectButton.classList.add('hidden');
        }

        sendResultsToGoogleSheet({
            setName: `P3 - ${currentSetData.setName}`, score: currentScore, totalQuestions: totalQuestions,
            percentage: percentage, timeTaken: timeDiff,
            incorrectAnswersJSON: JSON.stringify(incorrectAnswers.map(item => ({ q: item.questionData.question, u: item.userAnswer, c: item.questionData.correctAnswer }))),
            name: userName, timestamp: new Date().toISOString() 
        });

        if (isRedoing) { incorrectAnswers = []; isRedoing = false; }
    }

    function sendResultsToGoogleSheet(data) {
        fetch(APPS_SCRIPT_URL, {
            method: 'POST', mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({payloadType: 'flashcardResults', ...data, subject: 'P3 Chinese' })
        }).catch(err => console.error("Failed to send results:", err));
    }

    function redoIncorrect() {
        if (incorrectAnswers.length === 0) return;
        const originalSetName = currentSetData.setName.replace(" (é‡åš)", "");
        currentSetData = incorrectAnswers.map(item => item.questionData);
        currentSetData.setName = `${originalSetName} (é‡åš)`;
        currentQuestionIndex = 0;
        incorrectAnswers = []; 
        isRedoing = true;
        resultsScreen.classList.add('hidden');
        flashcardScreen.classList.remove('hidden');
        startTime = new Date();
        updateProgress(); 
        displayQuestion();
    }

    function showSetSelection() {
        if (proceedTimeoutId) { clearTimeout(proceedTimeoutId); }
        isWaitingToProceed = false; isRedoing = false; 
        nameModal.style.display = 'none';
        flashcardScreen.classList.add('hidden');
        resultsScreen.classList.add('hidden');
        setSelectionScreen.classList.remove('hidden');
        populateStartButton();
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        userName = localStorage.getItem(USER_NAME_STORAGE_KEY) || '';
        if (userName) {
            showSetSelection(); 
        } else {
            nameModal.style.display = 'flex';
            userNameInput.focus();
        }
    });
</script>

</body>
</html>
